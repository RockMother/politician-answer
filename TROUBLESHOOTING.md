# Troubleshooting

## Ошибка 409: Conflict (несколько экземпляров бота)

**Ошибка:**
```
GrammyError: Call to 'getUpdates' failed! (409: Conflict: terminated by other getUpdates request)
```

Это означает, что запущено несколько экземпляров бота одновременно.

### Решение:

#### 1. Проверьте статус webhook

```bash
BOT_TOKEN=your_token node scripts/check-bot-status.js
```

Если webhook установлен, удалите его:

```bash
BOT_TOKEN=your_token node scripts/delete-webhook.js
```

#### 2. Убедитесь, что бот не запущен локально

Закройте все терминалы где может быть запущен:
- `npm run dev`
- `npm start`
- `node dist/index.js`

#### 3. Проверьте количество инстансов на Render

1. Зайдите на [dashboard.render.com](https://dashboard.render.com)
2. Откройте ваш сервис
3. Убедитесь, что **Instance Count = 1** (не больше!)
4. Если было больше, уменьшите до 1 и подождите пару минут

#### 4. Перезапустите сервис на Render

В настройках сервиса нажмите **Manual Deploy** → **Clear build cache & deploy**

---

## Бот не отвечает в групповых чатах

Если бот не реагирует, когда вы делаете reply и тегаете его, проверьте следующее:

### 1. Privacy Mode должен быть отключен

По умолчанию боты в группах работают в "Privacy Mode" и видят только:
- Команды, начинающиеся с `/`
- Сообщения, где упомянут бот (@mention)
- Ответы на сообщения бота

Чтобы бот видел все сообщения в группе:

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/mybots`
3. Выберите вашего бота
4. Нажмите **Bot Settings**
5. Нажмите **Group Privacy**
6. Нажмите **Turn off** (должно стать "Privacy mode is disabled")

### 2. Бот должен быть администратором (опционально)

Хотя это не обязательно, сделайте бота администратором группы для лучшей работы:

1. Откройте настройки группы
2. **Administrators** → **Add Administrator**
3. Выберите бота
4. Минимальные права: "Delete messages" (опционально)

### 3. Правильный формат использования

Чтобы бот сработал, нужно:

1. **Reply** на чужое сообщение (нажать "Reply" в Telegram)
2. В тексте ответа упомянуть бота: `@YourBotUsername`
3. Можно добавить любой текст: `@YourBotUsername ответь на это`

❌ **Неправильно:**
- Просто написать `@BotUsername` без reply
- Сделать reply без упоминания бота

✅ **Правильно:**
- Reply на сообщение + `@BotUsername`
- Reply на сообщение + `@BotUsername please respond`

### 4. Проверка логов

После деплоя проверьте логи на Render:

1. Зайдите на [dashboard.render.com](https://dashboard.render.com)
2. Откройте ваш сервис
3. Перейдите на вкладку **Logs**
4. Попробуйте отправить сообщение боту
5. Проверьте, появились ли строки:
   - `Received message:` — бот получил сообщение
   - `Bot mentioned! Processing...` — бот распознал упоминание
   - `Successfully sent reply` — ответ отправлен

Если вы видите `Received message:` но не видите `Bot mentioned!`, значит проблема в распознавании упоминания.

### 5. Проверка переменных окружения

Убедитесь, что на Render установлены:
- `BOT_TOKEN` — токен от BotFather
- `OPENAI_API_KEY` — ключ OpenAI

### 6. Тестирование в личных сообщениях

Для теста отправьте боту в личку:
```
/start
```

Если бот отвечает — значит он работает, и проблема именно в настройках группового чата.

## Бот не запускается

Проверьте логи на наличие ошибок:
- `BOT_TOKEN environment variable is required` — не установлен токен
- `OPENAI_API_KEY environment variable is required` — не установлен ключ OpenAI
- `401 Unauthorized` — неверный токен бота или ключ OpenAI

## Бот работает медленно

OpenAI может отвечать медленно (5-30 секунд). Это нормально.
Вы увидите индикатор "typing..." пока бот генерирует ответ.

## Работа в нескольких каналах/группах

Один бот может работать в неограниченном количестве групп и каналов одновременно!

### Добавление в новую группу:

1. Откройте группу в Telegram
2. **Group Info** → **Add Members**
3. Найдите `@YourBotUsername`
4. Добавьте бота

### Настройки для каждой группы:

- **Privacy Mode должен быть отключен** (настройка глобальная для всех групп)
- Опционально: сделайте бота администратором для лучшей работы

### Ограничения:

- Бот использует long polling (одно соединение с Telegram)
- Один бот токен = один бот экземпляр
- **Не запускайте бота дважды с одним токеном!** (409 ошибка)

---

## Дополнительная помощь

Если проблема не решается:
1. Проверьте логи Render
2. Убедитесь, что бот был перезапущен после изменения настроек
3. Проверьте, что Privacy Mode отключен в BotFather
4. Убедитесь, что нет webhook: `node scripts/check-bot-status.js`
